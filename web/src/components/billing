import React, { useState } from 'react'
import { useTheme } from '../contexts/ThemeContext'
import { CreditCard, Shield, CheckCircle, AlertCircle, Banknote, Building2 } from 'lucide-react'

interface ACHPaymentSetupProps {
  onComplete: (achData: ACHData) => void
  onCancel: () => void
}

interface ACHData {
  bankName: string
  routingNumber: string
  accountNumber: string
  accountType: 'checking' | 'savings'
  accountHolderName: string
  billingAddress: string
  city: string
  state: string
  zip: string
  verified: boolean
}

const ACHPaymentSetup: React.FC<ACHPaymentSetupProps> = ({ onComplete, onCancel }) => {
  const { theme } = useTheme()
  const [step, setStep] = useState(1)
  const [formData, setFormData] = useState<ACHData>({
    bankName: '',
    routingNumber: '',
    accountNumber: '',
    accountType: 'checking',
    accountHolderName: '',
    billingAddress: '',
    city: '',
    state: '',
    zip: '',
    verified: false
  })
  const [errors, setErrors] = useState<Record<string, string>>({})
  const [isVerifying, setIsVerifying] = useState(false)

  const updateFormData = (field: keyof ACHData, value: string | boolean) => {
    setFormData(prev => ({ ...prev, [field]: value }))
    // Clear error when user starts typing
    if (errors[field]) {
      setErrors(prev => ({ ...prev, [field]: '' }))
    }
  }

  const validateForm = () => {
    const newErrors: Record<string, string> = {}

    if (!formData.bankName.trim()) newErrors.bankName = 'Bank name is required'
    if (!formData.routingNumber.trim()) newErrors.routingNumber = 'Routing number is required'
    else if (!/^\d{9}$/.test(formData.routingNumber)) newErrors.routingNumber = 'Routing number must be 9 digits'
    
    if (!formData.accountNumber.trim()) newErrors.accountNumber = 'Account number is required'
    else if (formData.accountNumber.length < 4) newErrors.accountNumber = 'Account number must be at least 4 digits'
    
    if (!formData.accountHolderName.trim()) newErrors.accountHolderName = 'Account holder name is required'
    if (!formData.billingAddress.trim()) newErrors.billingAddress = 'Billing address is required'
    if (!formData.city.trim()) newErrors.city = 'City is required'
    if (!formData.state.trim()) newErrors.state = 'State is required'
    if (!formData.zip.trim()) newErrors.zip = 'ZIP code is required'
    else if (!/^\d{5}(-\d{4})?$/.test(formData.zip)) newErrors.zip = 'ZIP code must be 5 or 9 digits'

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleNext = () => {
    if (step === 1) {
      if (validateForm()) {
        setStep(2)
      }
    } else if (step === 2) {
      handleVerifyAccount()
    }
  }

  const handleVerifyAccount = async () => {
    setIsVerifying(true)
    
    // Simulate ACH verification process
    setTimeout(() => {
      setIsVerifying(false)
      setFormData(prev => ({ ...prev, verified: true }))
      setStep(3)
    }, 3000)
  }

  const handleComplete = () => {
    onComplete(formData)
  }

  const renderStep1 = () => (
    <div style={{ display: 'grid', gap: '20px' }}>
      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        padding: '16px',
        background: theme.colors.backgroundSecondary,
        borderRadius: '8px',
        border: `1px solid ${theme.colors.border}`
      }}>
        <Shield size={24} color={theme.colors.primary} />
        <div>
          <h3 style={{ fontSize: '16px', fontWeight: '600', color: theme.colors.textPrimary, margin: '0 0 4px 0' }}>
            Secure ACH Payment Setup
          </h3>
          <p style={{ fontSize: '14px', color: theme.colors.textSecondary, margin: '0' }}>
            Your banking information is encrypted and secure. Required for TONU fees and commission payments.
          </p>
        </div>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
        <div>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
            Bank Name *
          </label>
          <input
            type="text"
            value={formData.bankName}
            onChange={(e) => updateFormData('bankName', e.target.value)}
            placeholder="Wells Fargo, Bank of America, etc."
            style={{
              width: '100%',
              padding: '12px 16px',
              background: theme.colors.backgroundSecondary,
              border: `2px solid ${errors.bankName ? theme.colors.error : theme.colors.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              color: theme.colors.textPrimary,
              outline: 'none'
            }}
          />
          {errors.bankName && (
            <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
              {errors.bankName}
            </div>
          )}
        </div>

        <div>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
            Account Type *
          </label>
          <select
            value={formData.accountType}
            onChange={(e) => updateFormData('accountType', e.target.value as 'checking' | 'savings')}
            style={{
              width: '100%',
              padding: '12px 16px',
              background: theme.colors.backgroundSecondary,
              border: `2px solid ${theme.colors.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              color: theme.colors.textPrimary,
              outline: 'none'
            }}
          >
            <option value="checking">Checking</option>
            <option value="savings">Savings</option>
          </select>
        </div>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
        <div>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
            Routing Number *
          </label>
          <input
            type="text"
            value={formData.routingNumber}
            onChange={(e) => updateFormData('routingNumber', e.target.value.replace(/\D/g, '').slice(0, 9))}
            placeholder="123456789"
            style={{
              width: '100%',
              padding: '12px 16px',
              background: theme.colors.backgroundSecondary,
              border: `2px solid ${errors.routingNumber ? theme.colors.error : theme.colors.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              color: theme.colors.textPrimary,
              outline: 'none'
            }}
          />
          {errors.routingNumber && (
            <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
              {errors.routingNumber}
            </div>
          )}
        </div>

        <div>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
            Account Number *
          </label>
          <input
            type="text"
            value={formData.accountNumber}
            onChange={(e) => updateFormData('accountNumber', e.target.value.replace(/\D/g, ''))}
            placeholder="Account number"
            style={{
              width: '100%',
              padding: '12px 16px',
              background: theme.colors.backgroundSecondary,
              border: `2px solid ${errors.accountNumber ? theme.colors.error : theme.colors.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              color: theme.colors.textPrimary,
              outline: 'none'
            }}
          />
          {errors.accountNumber && (
            <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
              {errors.accountNumber}
            </div>
          )}
        </div>
      </div>

      <div>
        <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
          Account Holder Name *
        </label>
        <input
          type="text"
          value={formData.accountHolderName}
          onChange={(e) => updateFormData('accountHolderName', e.target.value)}
          placeholder="Name as it appears on the account"
          style={{
            width: '100%',
            padding: '12px 16px',
            background: theme.colors.backgroundSecondary,
            border: `2px solid ${errors.accountHolderName ? theme.colors.error : theme.colors.border}`,
            borderRadius: '8px',
            fontSize: '14px',
            color: theme.colors.textPrimary,
            outline: 'none'
          }}
        />
        {errors.accountHolderName && (
          <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
            {errors.accountHolderName}
          </div>
        )}
      </div>

      <div>
        <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
          Billing Address *
        </label>
        <input
          type="text"
          value={formData.billingAddress}
          onChange={(e) => updateFormData('billingAddress', e.target.value)}
          placeholder="123 Main Street"
          style={{
            width: '100%',
            padding: '12px 16px',
            background: theme.colors.backgroundSecondary,
            border: `2px solid ${errors.billingAddress ? theme.colors.error : theme.colors.border}`,
            borderRadius: '8px',
            fontSize: '14px',
            color: theme.colors.textPrimary,
            outline: 'none'
          }}
        />
        {errors.billingAddress && (
          <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
            {errors.billingAddress}
          </div>
        )}
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px' }}>
        <div>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
            City *
          </label>
          <input
            type="text"
            value={formData.city}
            onChange={(e) => updateFormData('city', e.target.value)}
            placeholder="Dallas"
            style={{
              width: '100%',
              padding: '12px 16px',
              background: theme.colors.backgroundSecondary,
              border: `2px solid ${errors.city ? theme.colors.error : theme.colors.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              color: theme.colors.textPrimary,
              outline: 'none'
            }}
          />
          {errors.city && (
            <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
              {errors.city}
            </div>
          )}
        </div>

        <div>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
            State *
          </label>
          <select
            value={formData.state}
            onChange={(e) => updateFormData('state', e.target.value)}
            style={{
              width: '100%',
              padding: '12px 16px',
              background: theme.colors.backgroundSecondary,
              border: `2px solid ${errors.state ? theme.colors.error : theme.colors.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              color: theme.colors.textPrimary,
              outline: 'none'
            }}
          >
            <option value="">Select State</option>
            <option value="TX">Texas</option>
            <option value="CA">California</option>
            <option value="FL">Florida</option>
            <option value="NY">New York</option>
            <option value="IL">Illinois</option>
            <option value="PA">Pennsylvania</option>
            <option value="OH">Ohio</option>
            <option value="GA">Georgia</option>
            <option value="NC">North Carolina</option>
            <option value="MI">Michigan</option>
          </select>
          {errors.state && (
            <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
              {errors.state}
            </div>
          )}
        </div>

        <div>
          <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '8px' }}>
            ZIP Code *
          </label>
          <input
            type="text"
            value={formData.zip}
            onChange={(e) => updateFormData('zip', e.target.value.replace(/\D/g, '').slice(0, 9))}
            placeholder="75201"
            style={{
              width: '100%',
              padding: '12px 16px',
              background: theme.colors.backgroundSecondary,
              border: `2px solid ${errors.zip ? theme.colors.error : theme.colors.border}`,
              borderRadius: '8px',
              fontSize: '14px',
              color: theme.colors.textPrimary,
              outline: 'none'
            }}
          />
          {errors.zip && (
            <div style={{ fontSize: '12px', color: theme.colors.error, marginTop: '4px' }}>
              {errors.zip}
            </div>
          )}
        </div>
      </div>
    </div>
  )

  const renderStep2 = () => (
    <div style={{ textAlign: 'center', padding: '40px 20px' }}>
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '12px',
        marginBottom: '20px'
      }}>
        <Banknote size={48} color={theme.colors.primary} />
        <Building2 size={48} color={theme.colors.primary} />
      </div>
      
      <h3 style={{ fontSize: '24px', fontWeight: 'bold', color: theme.colors.textPrimary, marginBottom: '16px' }}>
        Verifying Your Account
      </h3>
      
      <p style={{ fontSize: '16px', color: theme.colors.textSecondary, marginBottom: '30px' }}>
        We're securely verifying your banking information with {formData.bankName}.<br />
        This process typically takes 1-3 business days.
      </p>

      <div style={{
        background: theme.colors.backgroundSecondary,
        padding: '20px',
        borderRadius: '8px',
        border: `1px solid ${theme.colors.border}`,
        marginBottom: '30px'
      }}>
        <h4 style={{ fontSize: '16px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '12px' }}>
          What happens next:
        </h4>
        <ul style={{ textAlign: 'left', fontSize: '14px', color: theme.colors.textSecondary, lineHeight: '1.6' }}>
          <li>We'll make two small deposits to your account (less than $1 each)</li>
          <li>You'll receive an email with the exact amounts</li>
          <li>Return to the platform and enter these amounts to complete verification</li>
          <li>Once verified, you can post loads and accept carriers</li>
        </ul>
      </div>

      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        padding: '16px',
        background: theme.colors.backgroundTertiary,
        borderRadius: '8px',
        border: `1px solid ${theme.colors.border}`
      }}>
        <Shield size={20} color={theme.colors.success} />
        <span style={{ fontSize: '14px', color: theme.colors.textPrimary }}>
          Your banking information is encrypted and secure
        </span>
      </div>
    </div>
  )

  const renderStep3 = () => (
    <div style={{ textAlign: 'center', padding: '40px 20px' }}>
      <CheckCircle size={64} color={theme.colors.success} style={{ marginBottom: '20px' }} />
      
      <h3 style={{ fontSize: '24px', fontWeight: 'bold', color: theme.colors.textPrimary, marginBottom: '16px' }}>
        ACH Account Verified!
      </h3>
      
      <p style={{ fontSize: '16px', color: theme.colors.textSecondary, marginBottom: '30px' }}>
        Your {formData.bankName} {formData.accountType} account ending in 
        {formData.accountNumber.slice(-4)} has been successfully verified.
      </p>

      <div style={{
        background: theme.colors.backgroundSecondary,
        padding: '20px',
        borderRadius: '8px',
        border: `1px solid ${theme.colors.border}`,
        marginBottom: '30px'
      }}>
        <h4 style={{ fontSize: '16px', fontWeight: '600', color: theme.colors.textPrimary, marginBottom: '12px' }}>
          You can now:
        </h4>
        <ul style={{ textAlign: 'left', fontSize: '14px', color: theme.colors.textSecondary, lineHeight: '1.6' }}>
          <li>Post loads and accept carrier bids</li>
          <li>Pay commission fees automatically</li>
          <li>Use QuickPay for immediate carrier payments</li>
          <li>Process all platform-related charges</li>
        </ul>
      </div>
    </div>
  )

  return (
    <div style={{
      maxWidth: '600px',
      margin: '0 auto',
      padding: '40px',
      background: theme.colors.background,
      color: theme.colors.textPrimary,
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
    }}>
      {/* Header */}
      <div style={{
        textAlign: 'center',
        marginBottom: '40px',
        borderBottom: `2px solid ${theme.colors.primary}`,
        paddingBottom: '20px'
      }}>
        <h1 style={{
          fontSize: '28px',
          fontWeight: 'bold',
          margin: '0 0 10px 0',
          color: theme.colors.textPrimary
        }}>
          ACH Payment Setup
        </h1>
        <p style={{
          fontSize: '16px',
          color: theme.colors.textSecondary,
          margin: '0'
        }}>
          Required for TONU fees and commission payments
        </p>
      </div>

      {/* Progress Steps */}
      <div style={{
        display: 'flex',
        justifyContent: 'center',
        marginBottom: '40px'
      }}>
        {[1, 2, 3].map((stepNum) => (
          <div key={stepNum} style={{
            display: 'flex',
            alignItems: 'center',
            gap: '8px'
          }}>
            <div style={{
              width: '32px',
              height: '32px',
              borderRadius: '50%',
              background: step >= stepNum ? theme.colors.primary : theme.colors.backgroundSecondary,
              color: step >= stepNum ? theme.colors.background : theme.colors.textSecondary,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '14px',
              fontWeight: 'bold'
            }}>
              {stepNum}
            </div>
            {stepNum < 3 && (
              <div style={{
                width: '40px',
                height: '2px',
                background: step > stepNum ? theme.colors.primary : theme.colors.border
              }} />
            )}
          </div>
        ))}
      </div>

      {/* Content */}
      {step === 1 && renderStep1()}
      {step === 2 && renderStep2()}
      {step === 3 && renderStep3()}

      {/* Actions */}
      <div style={{
        display: 'flex',
        gap: '15px',
        justifyContent: 'center',
        marginTop: '40px',
        paddingTop: '20px',
        borderTop: `1px solid ${theme.colors.border}`
      }}>
        {step > 1 && (
          <button
            onClick={() => setStep(step - 1)}
            style={{
              padding: '12px 24px',
              background: theme.colors.backgroundSecondary,
              color: theme.colors.textPrimary,
              border: `1px solid ${theme.colors.border}`,
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '600'
            }}
          >
            Back
          </button>
        )}

        {step < 3 ? (
          <button
            onClick={handleNext}
            disabled={isVerifying}
            style={{
              padding: '12px 24px',
              background: isVerifying ? theme.colors.backgroundSecondary : theme.colors.primary,
              color: isVerifying ? theme.colors.textSecondary : theme.colors.background,
              border: 'none',
              borderRadius: '8px',
              cursor: isVerifying ? 'not-allowed' : 'pointer',
              fontSize: '14px',
              fontWeight: '600',
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}
          >
            {isVerifying ? (
              <>
                <div style={{
                  width: '16px',
                  height: '16px',
                  border: `2px solid ${theme.colors.textSecondary}`,
                  borderTop: `2px solid transparent`,
                  borderRadius: '50%',
                  animation: 'spin 1s linear infinite'
                }} />
                Verifying...
              </>
            ) : (
              step === 1 ? 'Verify Account' : 'Continue'
            )}
          </button>
        ) : (
          <button
            onClick={handleComplete}
            style={{
              padding: '12px 24px',
              background: theme.colors.success,
              color: theme.colors.background,
              border: 'none',
              borderRadius: '8px',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '600',
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}
          >
            <CheckCircle size={16} />
            Complete Setup
          </button>
        )}

        <button
          onClick={onCancel}
          style={{
            padding: '12px 24px',
            background: theme.colors.backgroundSecondary,
            color: theme.colors.textPrimary,
            border: `1px solid ${theme.colors.border}`,
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '600'
          }}
        >
          Cancel
        </button>
      </div>
    </div>
  )
}

export default ACHPaymentSetup
